#!/bin/bash
cd test
rm native-obfuscator.jar
cp ../build/libs/native-obfuscator.jar native-obfuscator.jar
mkdir temp/current
mkdir temp/test_build
for test_dir in `find tests -mindepth 1 -type d`
do
    test_id=`basename $test_dir`

    echo -e "\e[93mTest #"$test_id"\e[0m"
    # cleanup
    rm -rf temp/current/*
    rm -rf temp/test_build/*
    rm temp/test_build.jar

    # compiling
    javac -d temp/test_build $test_dir/*.java 
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    jar cvfe temp/test_build.jar Test -C temp/test_build/ .
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi

    # making test
    java -jar native-obfuscator.jar temp/test_build.jar temp/current
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    cd temp/current/cpp
    cmake .
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    cmake --build . --config Release
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    cd ../../..
    cp temp/current/cpp/Release/* temp/current/*

    # testing
    cd temp/current
    java -jar test.jar
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    cd ../..
done
