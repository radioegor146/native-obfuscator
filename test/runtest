#!/bin/bash
cd test
rm -f native-obfuscator.jar
cp ../build/libs/native-obfuscator.jar native-obfuscator.jar
mkdir -p temp/current
mkdir -p temp/test_build
for test_dir in `find tests -mindepth 1 -type d`
do
    test_id=`basename $test_dir`

    echo -e "\e[93mTest #"$test_id"\e[0m"
    # cleanup
    rm -rf temp/current/*
    rm -rf temp/test_build/*
    rm -f temp/test_build.jar

    # compiling
    cp $test_dir/output temp/current/test.ideal
    javac -d temp/test_build $test_dir/source/*.java 
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    jar cvfe temp/test_build.jar Test -C temp/test_build/ .
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi

    # making test
    java -jar native-obfuscator.jar temp/test_build.jar temp/current
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    cd temp/current/cpp
    cmake .
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    cmake --build . --config Release
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    cd ../../..
    cp temp/current/cpp/build/Release/lib/* temp/current/*

    # testing
    cd temp/current
    java -Djava.library.path=. -jar test.jar > test.no
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
    cd ../..

    # checking
    cmp -s temp/current/test.no temp/current/test.ideal
    rc=$?; if [[ $rc != 0 ]]; then exit $rc; fi
done
